<!DOCTYPE html>
<!--
Copyright (c) 2019 Andrew Vardeman.  Published under the MIT license.
See license.txt in the IcollatorForever distribution or repository for the
full text of the license.
-->
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Icollator Forever</title>
    <base href="/" />
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/site.css" rel="stylesheet" />
    <script type="text/javascript">

        function loadFiles(files) {
            for (var i = 0; i < files.length; i++) {
                addIconFile(files[i]);
            }
        }

        function addIconFile(file) {
            var reader = new FileReader();
            reader.onload = function () {
                DotNet.invokeMethod('IcollatorForever', 'AddFile', file.name, btoa(reader.result));
            }
            reader.readAsBinaryString(file);
        }

        function clearTable() {
            var yes = confirm('Clear the table and start over?');
            if (yes) {
                DotNet.invokeMethod('IcollatorForever', 'Clear');
            }
        }

        function select(index) {
            DotNet.invokeMethod('IcollatorForever', 'Select', index);
        }

        function deleteSelected() {
            DotNet.invokeMethod('IcollatorForever', 'DeleteSelected');
        }

        // https://stackoverflow.com/questions/13405129/javascript-create-and-save-file
        function download(data, filename, type) {
            var file = new Blob([data], {type: type});
            if (window.navigator.msSaveOrOpenBlob) // IE10+
                window.navigator.msSaveOrOpenBlob(file, filename);
            else { // Others
                var a = document.createElement("a"),
                        url = URL.createObjectURL(file);
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(function() {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);  
                }, 0); 
            }
        }

        function saveFile() {
            var base64 = DotNet.invokeMethod('IcollatorForever', 'GenerateBase64IcoString');
            var byteChars = atob(base64);
            const byteNumbers = new Array(byteChars.length);
            for (let i = 0; i < byteChars.length; i++) {
                byteNumbers[i] = byteChars.charCodeAt(i);
            }
            const bytes = new Uint8Array(byteNumbers);
            download(bytes, "icon.ico", "image/x-icon");
        }

        function handleDrop(e) {
            preventDefault(e);
            stopPropagation(e); // don't redirect
            
            e.target.classList.remove('over');

            var files = [];
            var items = e.dataTransfer.items;
            if (items) {
                for (var i = 0; i < items.length; i++) {
                    if (items[i].kind === 'file') {
                        files.push(items[i].getAsFile());
                    }
                }
            } else {
                files = e.dataTransfer.files;
            }

            loadFiles(files);
            return false;
        }

        function handleDragOver(e) {
            preventDefault(e);
            e.dataTransfer.dropEffect = 'link';
            return false;
        }

        function handleDragEnter(e) {

            // Prevent default behavior (Prevent file from being opened)
            e.preventDefault();

            var hasFiles = false;

            if (e.dataTransfer.items) {
                for (var i = 0; i < e.dataTransfer.items.length; i++) {
                    if (e.dataTransfer.items[i].kind === 'file') {
                        hasFiles = true;
                        break;
                    }
                }
            } else {
                hasFiles = e.dataTransfer.files.length > 0;
            }

            preventDefault(e);
            e.dataTransfer.dropEffect = 'link';
            e.target.classList.add('over');
            return false;
        }

        function handleDragLeave(e) {
            preventDefault(e);
            e.target.classList.remove('over');
            return false;
        }

        function preventDefault(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
        }

        function stopPropagation(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
        }

    </script>
</head>
<body>
    <app>Loading...</app>

    <script type="text/javascript">
        setInterval(function () {
            var input = document.getElementById("mainFileInput");
            if (input) {
                var parent = input.parentNode;
                var files = input.files;
                if (files && files.length > 0) {
                    parent.removeChild(input);
                    loadFiles(files);
                    var newInput = document.createElement("input");
                    var names = input.getAttributeNames();
                    for (var i = 0; i < names.length; i++) {
                        var name = names[i];
                        newInput.setAttribute(name, input.getAttribute(name));
                    }
                    parent.appendChild(newInput);
                }
            }
        }, 1000);
    </script>
    <script src="_framework/blazor.webassembly.js"></script>
</body>
</html>
